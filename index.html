<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<title>Hl√°senie ‚Äì Transf√∫zie FINAL v1.32</title>

<style>
  :root{
    --bg:#0b1220;
    --card:#0f172a;
    --border:#22314a;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --primary:#60a5fa;
    --danger:#dc2626;
    --shadow:0 10px 24px rgba(0,0,0,.35);
    --radius:16px;
    --ok:#22c55e;
    --warn:#f59e0b;
  }

  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--text);
    padding-bottom: 80px;
  }
  header{
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(10px);
    background: color-mix(in oklab, var(--bg) 78%, transparent);
    border-bottom:1px solid var(--border);
    padding-bottom: 10px;
  }
  .wrap{max-width:1020px; margin:0 auto; padding:14px 14px 28px;}
  .top{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center; justify-content:space-between;
  }
  h1{font-size:18px; margin:0;}
  .subtitle{font-size:12px; color:var(--muted); margin-top:4px;}
  .btnrow{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top: 5px;}

  button{
    border:1px solid var(--border);
    background:var(--card);
    color:var(--text);
    padding:10px 12px;
    border-radius:12px;
    font-size:13px;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
    box-shadow: 0 4px 12px rgba(0,0,0,.10);
  }
  button.primary{
    background:var(--primary);
    color:#071022;
    border-color: color-mix(in oklab, var(--primary) 70%, var(--border));
    font-weight:700;
  }
  button.danger{
    background: color-mix(in oklab, var(--danger) 12%, var(--card));
    border-color: color-mix(in oklab, var(--danger) 50%, var(--border));
  }
  button.mini{
    padding:7px 10px;
    font-size:12px;
    border-radius:999px;
    box-shadow:none;
  }
  button.ok{
    background: color-mix(in oklab, var(--ok) 18%, var(--card));
    border-color: color-mix(in oklab, var(--ok) 50%, var(--border));
  }
  
  button.usb-btn {
    background: color-mix(in oklab, var(--warn) 15%, var(--card));
    border-color: var(--warn);
    color: var(--warn);
    font-weight: bold;
  }

  .file-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 99px;
    background: var(--card);
    border: 1px solid var(--border);
    margin-left: 10px;
    color: var(--muted);
  }
  .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; transition: background 0.3s; }
  .dot.active { background: var(--ok); box-shadow: 0 0 6px var(--ok); }
  .dot.saving { background: var(--warn); }
  .dot.error { background: var(--danger); }

  /* --- CARD STYLING --- */
  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    margin-top:12px;
    transition: all 0.4s ease;
  }
  
  .card.patientCard {
    opacity: 0.55;
    transform: scale(0.99);
    filter: grayscale(0.4);
  }

  .card.patientCard.active-card {
    opacity: 1;
    transform: scale(1);
    border: 2px solid var(--primary);
    box-shadow: 0 0 20px rgba(96, 165, 250, 0.15);
    filter: grayscale(0);
    z-index: 10;
  }

  .cardhead{
    padding:12px 14px;
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:center;
    border-bottom:1px solid var(--border);
    cursor: pointer;
  }
  .cardhead b{font-size:14px;}
  .content{padding:12px 14px 14px;}

  label{
    display:block;
    font-size:12px;
    color:var(--muted);
    margin-bottom:6px;
  }
  input, textarea, select{
    width:100%;
    border:1px solid var(--border);
    background: color-mix(in oklab, var(--card) 92%, var(--bg));
    color:var(--text);
    padding:10px 10px;
    border-radius:12px;
    outline:none;
    font-size:14px;
  }
  input[type="number"]{ appearance:textfield; }
  textarea{min-height:60px; resize:vertical;}

  .row{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:10px;
    margin-bottom:10px;
  }
  @media (max-width: 740px){
    .row{grid-template-columns: 1fr;}
  }

  .mini4{
    display:grid;
    grid-template-columns: repeat(4,1fr);
    gap:10px;
    margin-bottom:10px;
  }
  @media (max-width: 740px){
    .mini4{grid-template-columns: repeat(2,1fr);}
  }

  .checks{
    display:flex; gap:10px; flex-wrap:wrap;
    align-items:center;
    padding:8px 10px;
    border:1px solid var(--border);
    border-radius:12px;
    background: color-mix(in oklab, var(--card) 92%, var(--bg));
  }
  .checks label{
    margin:0;
    display:flex; align-items:center; gap:8px;
    font-size:13px;
    color:var(--text);
  }
  .checks input{width:auto;}

  .inlineTools{
    display:flex; gap:6px; flex-wrap:wrap;
    margin-top:6px;
  }

  .subBlock{
    border:1px dashed color-mix(in oklab, var(--border) 70%, transparent);
    border-radius:14px;
    padding:10px;
    margin-bottom:10px;
    background: color-mix(in oklab, var(--card) 88%, var(--bg));
  }

  .hidden{display:none !important;}
  .hint{ color:var(--muted); font-size:12px; }
  .badge{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:11px;
    border:1px solid var(--border);
    color:var(--muted);
  }

  .aaInput{
    border-color: color-mix(in oklab, var(--danger) 70%, var(--border)) !important;
    background: color-mix(in oklab, var(--danger) 14%, var(--card)) !important;
  }

  /* --- ISOLATION BOX --- */
  .isoBox {
    border: 1px solid var(--danger);
    background: color-mix(in oklab, var(--danger) 10%, var(--card));
    padding: 10px;
    border-radius: 12px;
    margin-bottom: 15px; /* Added spacing below */
  }
  .isoBox label { color: var(--danger); font-weight: bold; }

  details{
    border:1px solid color-mix(in oklab, var(--border) 70%, transparent);
    border-radius:14px;
    padding:8px 10px;
    background: color-mix(in oklab, var(--card) 92%, var(--bg));
    margin-top:10px;
  }
  summary{
    cursor:pointer;
    list-style:none;
    font-weight:700;
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  summary::-webkit-details-marker{ display:none; }
  .sumRight{ color:var(--muted); font-weight:600; font-size:12px; }

  /* --- BOTTOM DOCK --- */
  .nav-dock {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(12px);
    border: 1px solid var(--border);
    padding: 8px 16px;
    border-radius: 99px;
    display: flex;
    gap: 12px;
    z-index: 1000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }
  .dock-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .dock-btn:hover { transform: scale(1.1); }
  .dock-btn.active {
    background: var(--primary);
    color: #000;
    border-color: var(--primary);
    box-shadow: 0 0 10px var(--primary);
  }
  .dock-label {
    position: absolute; top:-25px; left:50%; transform:translateX(-50%);
    font-size: 10px; color: var(--muted); background: var(--bg);
    padding: 2px 6px; border-radius: 4px; pointer-events: none;
    white-space: nowrap;
  }

  /* --- BLOOD SLOTS (CSS TOGGLE) --- */
  .blood-slot-container {
    display: none; /* Default hidden */
  }
  .blood-slot-container.active {
    display: block; /* Show when active */
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .blood-summary-text {
    font-size: 11px;
    color: var(--ok);
    margin-left: 6px;
    font-weight: 600;
  }

</style>
</head>

<body>

<div class="nav-dock">
  <div class="dock-label">R√Ωchla navig√°cia</div>
  <div class="dock-btn" id="nav_btn_1" onclick="focusPatient(1)">1</div>
  <div class="dock-btn" id="nav_btn_2" onclick="focusPatient(2)">2</div>
  <div class="dock-btn" id="nav_btn_3" onclick="focusPatient(3)">3</div>
  <div class="dock-btn" id="nav_btn_4" onclick="focusPatient(4)">4</div>
  <div class="dock-btn" id="nav_btn_5" onclick="focusPatient(5)">5</div>
</div>

<header>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Hl√°senie v1.32 (HK & FONTS)</h1>
        <div class="subtitle">
          HK: Dnes x (y x), Jednotn√© p√≠smo tlaƒçe
        </div>
        <div class="file-status" id="statusBox" style="display:none;">
          <div class="dot" id="statusDot"></div>
          <span id="statusText">Lok√°lny re≈æim</span>
        </div>
      </div>
      <div class="btnrow">
        <button class="usb-btn" onclick="openLocalFile()">üìÇ Otvori≈• s√∫bor (USB)</button>
        <button class="primary" onclick="printFilledIOS()">Tlaƒç / PDF</button>
        <button onclick="exportJSON()">Export JSON</button>
        <button onclick="document.getElementById('fileImport').click()">Import JSON</button>
        <button class="danger" onclick="resetAll()">Vymaza≈• v≈°etko</button>
      </div>
    </div>
    <input id="fileImport" type="file" accept="application/json" class="hidden" />
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="cardhead"><b>Hlaviƒçka slu≈æby</b></div>
    <div class="content">
      <div class="row">
        <div>
          <label>Slu≈æba</label>
          <select id="shiftType">
            <option value="celodenna">Celodenn√© hl√°senie</option>
            <option value="nocna">Noƒçn√© hl√°senie</option>
          </select>
        </div>
        <div>
          <label>Sestra</label>
          <input id="nurseName" type="text" placeholder="meno sestry" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>D√°tum (staƒç√≠ de≈à)</label>
          <input id="handoverDay" type="date" />
          <div class="inlineTools">
            <button class="mini" onclick="setHeaderDay('today')">Dnes</button>
            <button class="mini" onclick="setHeaderDay('tomorrow')">Zajtra</button>
          </div>
        </div>
        <div class="hint">
          Tlaƒç bude bez ƒçasu.
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="cardhead">
      <b>Od√≠den√≠ (prepusten√Ω / prelo≈æen√Ω)</b>
      <span class="badge" id="leftCount">0</span>
    </div>
    <div class="content">
      <div class="hint">Prepusten√≠ bud√∫ na konci nad prelo≈æen√Ωmi.</div>
      <div id="leftList" style="margin-top:10px;"></div>
    </div>
  </div>

  <div id="patients"></div>
</main>

<script>
  const STORAGE_KEY = "HLASENIE_V132_HK_FONTS";

  // --- FOCUS MODE LOGIC ---
  function focusPatient(i){
    document.querySelectorAll('.patientCard').forEach(c => c.classList.remove('active-card'));
    document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
    const card = document.getElementById(`patient_${i}`);
    const btn = document.getElementById(`nav_btn_${i}`);
    if(card) {
      card.classList.add('active-card');
      card.scrollIntoView({behavior: "smooth", block: "center"});
    }
    if(btn) btn.classList.add('active');
  }

  document.addEventListener('focusin', (e) => {
    const card = e.target.closest('.patientCard');
    if(card){
      const idStr = card.id.replace('patient_', '');
      const id = parseInt(idStr);
      document.querySelectorAll('.patientCard').forEach(c => c.classList.remove('active-card'));
      document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
      card.classList.add('active-card');
      const btn = document.getElementById(`nav_btn_${id}`);
      if(btn) btn.classList.add('active');
    }
  });

  function activateCardClick(i){
    focusPatient(i);
  }

  // --- USB ---
  let fileHandle = null;
  let usbSaveTimer = null;

  async function openLocalFile() {
    if (!('showOpenFilePicker' in window)) {
      alert("Tento prehliadaƒç nepodporuje priamy z√°pis na USB.");
      return;
    }
    try {
      const [handle] = await window.showOpenFilePicker({
        types: [{ description: 'JSON S√∫bory', accept: { 'application/json': ['.json'] } }],
        multiple: false
      });
      fileHandle = handle;
      const file = await fileHandle.getFile();
      const text = await file.text();
      if (text.trim().length > 0) {
        try {
          JSON.parse(text);
          localStorage.setItem(STORAGE_KEY, text);
          load();
          alert("D√°ta z USB naƒç√≠tan√© ‚úÖ");
        } catch (e) {
          alert("S√∫bor je po≈°koden√Ω. Zaƒç√≠nam pr√°zdny formul√°r.");
          resetAll(false);
        }
      } else {
        alert("S√∫bor je pr√°zdny. M√¥≈æe≈° zaƒça≈• p√≠sa≈•.");
      }
      updateFileStatus(true, file.name);
    } catch (err) {
      if (err.name !== 'AbortError') { console.error(err); alert("Nepodarilo sa otvori≈• s√∫bor."); }
    }
  }

  function scheduleSaveToDisk(){
    if(!fileHandle) return;
    if(usbSaveTimer) clearTimeout(usbSaveTimer);
    usbSaveTimer = setTimeout(()=>{ saveToDisk(); }, 1000);
  }

  async function saveToDisk() {
    if (!fileHandle) return;
    try {
      updateFileStatus(true, "Uklad√°m...", true);
      const writable = await fileHandle.createWritable();
      const data = localStorage.getItem(STORAGE_KEY) || "{}";
      await writable.write(data);
      await writable.close();
      setTimeout(() => {
        const fname = fileHandle?.name || "S√∫bor";
        updateFileStatus(true, fname);
      }, 400);
    } catch (err) {
      console.error("Chyba z√°pisu na USB:", err);
      updateFileStatus(false, "Chyba z√°pisu!");
    }
  }

  function updateFileStatus(connected, text, saving = false) {
    const box = document.getElementById("statusBox");
    const dot = document.getElementById("statusDot");
    const txt = document.getElementById("statusText");
    box.style.display = "inline-flex";
    txt.textContent = text;
    dot.className = "dot";
    if (saving) dot.classList.add("saving");
    else if (connected) dot.classList.add("active");
    else dot.classList.add("error");
  }

  // ------- Helpers -------
  function pad(n){ return String(n).padStart(2,'0'); }
  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function isoAddDays(iso, add){
    if(!iso) return "";
    const d = new Date(iso + "T00:00:00");
    if(isNaN(d.getTime())) return ""; 
    d.setDate(d.getDate() + add);
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }
  function cleanSpaces(s){ return String(s||"").replace(/\s+/g," ").trim(); }
  function escapeHTML(str){
    return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function formatDateSK(iso){
    if(!iso) return "";
    const d = iso.split("-");
    return `${d[2]}.${d[1]}.${d[0]}`.trim();
  }
  function isTomorrow(dateISO){ return !!dateISO && dateISO === isoAddDays(todayISO(), 1); }
  function isToday(dateISO){ return !!dateISO && dateISO === todayISO(); }
  
  function formatTimeSK(timeStr){
    if(!timeStr) return "";
    let t = timeStr.trim();
    if(t.startsWith("0")) t = t.substring(1); 
    t = t.replace(":", ",");
    return `${t} hod.`;
  }
  function setHeaderDay(which){
    let d = todayISO();
    if(which === "tomorrow") d = isoAddDays(todayISO(),1);
    document.getElementById("handoverDay").value = d;
    save();
  }
  function defaultHeaderDay(){ document.getElementById("handoverDay").value = todayISO(); }

  // ------- Rendering -------
  function patientTemplate(i){
    // STATIC BLOOD SLOTS GENERATION
    let bloodSlotsHTML = "";
    for(let s=1; s<=4; s++){
      bloodSlotsHTML += `
      <div id="blood_wrap_${i}_${s}" class="blood-slot-container">
        <div class="subBlock" style="margin-bottom:10px;">
          <input type="checkbox" class="hidden" data-k="p${i}_blood${s}_on" onchange="syncBloodVisibility(${i})" />
          <input type="hidden" data-k="p${i}_blood${s}_today_accumulator" value="0" />
          
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
             <div>
               <b>Pr√≠pravok ${s}</b>
               <span id="blood_summary_${i}_${s}" class="blood-summary-text"></span>
             </div>
             <button class="mini danger" type="button" onclick="removeBloodSlot(${i}, ${s})">Vymaza≈•</button>
          </div>

          <div class="row">
            <div><label>Typ</label><select id="p${i}_b${s}_type" data-k="p${i}_blood${s}_type"><option value="">-</option><option value="TUEM">TUEM</option><option value="ƒåMP">ƒåMP</option><option value="TK">trombokoncentr√°t</option></select></div>
            <div><label>Pripraven√© (zostatok)</label><input id="p${i}_b${s}_ready" data-k="p${i}_blood${s}_ready" type="number" min="0" /></div>
          </div>
          <div class="row">
            <div><label>Zaisten√©</label><input id="p${i}_b${s}_sec" data-k="p${i}_blood${s}_secured" type="number" min="0" /></div>
            <div>
              <label>Podan√© (ks) / Pl√°n poda≈•</label>
              <input id="p${i}_b${s}_given" data-k="p${i}_blood${s}_given_count" type="number" min="0" />
              <button class="mini ok" style="margin-top:4px;" onclick="applyBloodGiven(${i},${s})">Odpoƒç√≠ta≈•</button>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Kedy poda≈• (d√°tum)</label><input id="p${i}_b${s}_date" data-k="p${i}_blood${s}_date" type="date"/>
              <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_blood${s}_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_blood${s}_date','tomorrow')">Zajtra</button></div>
            </div>
            <div><label>Kedy poda≈• (ƒças)</label><input id="p${i}_b${s}_time" data-k="p${i}_blood${s}_time" type="time"/></div>
          </div>
        </div>
      </div>
      `;
    }

    return `
    <section class="card patientCard" id="patient_${i}">
      <div class="cardhead" onclick="activateCardClick(${i})">
        <b>Pacient ${i} (klikni pre √∫pravu)</b>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="ok" onclick="finishPatient(${i}); event.stopPropagation();">Ulo≈æi≈• ako od√≠den√Ω</button>
          <button onclick="clearPatient(${i}); event.stopPropagation();">Vymaza≈•</button>
        </div>
      </div>

      <div class="content">
        <div class="mini4">
          <div><label>Izba/l√¥≈æko</label><input data-k="p${i}_bed" type="text" placeholder="" /></div>
          <div><label>Priezvisko</label><input data-k="p${i}_surname" type="text" placeholder="Nov√°k" /></div>
          <div><label>Meno</label><input data-k="p${i}_name" type="text" placeholder="J√°n" /></div>
          <div>
            <label>PR</label>
            <select data-k="p${i}_pr">
              <option value="">-</option>
              <option value="A">A</option>
              <option value="A+WC">A+WC</option>
              <option value="A KOS">A KOS</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div><label>AA: (alergia)</label><input class="aaInput" data-k="p${i}_allergy" type="text" placeholder="napr. Penicil√≠n" /></div>
          <div>
            <label>D√°tum prijatia</label><input data-k="p${i}_admit_date" type="date" />
            <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_admit_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_admit_date','yesterday')">Vƒçera</button></div>
          </div>
        </div>

        <div class="isoBox">
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
               <label style="margin:0;">IZOL√ÅCIA</label>
               <div class="checks" style="background:transparent; border:none; padding:0;"><label><input type="checkbox" data-k="p${i}_iso_on" /> Akt√≠vna</label></div>
             </div>
             <input type="text" data-k="p${i}_iso_reason" placeholder="D√¥vod (napr. Clostridium)" style="background:#fff; color:#000;" />
        </div>

        <div class="subBlock">
          <div class="row">
            <div><label>EKG</label><input data-k="p${i}_ekg" type="text" placeholder="denne / VV" /></div>
            <div><label>TK</label><input data-k="p${i}_tk" type="text" placeholder="napr. ≈°okov√° / 3x / TK ≈°okov√°" /></div>
          </div>
          <div class="row">
            <div><label>Monitorova≈•</label><div class="checks"><label><input type="checkbox" data-k="p${i}_mon_check" /> monitorova≈•</label></div></div>
            <div><label>Bilancia</label><div class="checks"><label><input type="checkbox" data-k="p${i}_pv_check" /> P+V</label></div></div>
          </div>
          <div class="row">
             <div>
               <label>Inzul√≠n / GP</label>
               <div class="checks"><label><input type="checkbox" data-k="p${i}_inz_on" /> Inz. dƒæa glyk√©mie</label></div>
               <div id="inz_box_${i}" class="hidden" style="margin-top:5px;">
                  <label>Per√° sa nach√°dzaj√∫:</label>
                  <select data-k="p${i}_inz_loc"><option value="u seba">U seba</option><option value="v chladniƒçke">V chladniƒçke</option></select>
               </div>
             </div>
             <div>
               <label>Re≈æim (MGP/RGP/VGP)</label>
               <select data-k="p${i}_gp_type">
                 <option value="">-</option>
                 <option value="MGP">MGP</option>
                 <option value="RGP">RGP</option>
                 <option value="VGP">VGP</option>
               </select>
             </div>
          </div>
          
          <div style="margin-top:10px;">
             <label>Sledova≈• (napr. krv√°canie, odpad...)</label>
             <input data-k="p${i}_watch" type="text" />
          </div>

          <div class="row" style="margin-top:10px;">
            <div><label>Lieky (struƒçne)</label><input data-k="p${i}_drugs" type="text" placeholder="napr. ASA, Betaloc..." /></div>
            <div><label>Voƒæn√Ω text</label><input data-k="p${i}_note" type="text" placeholder="ƒèal≈°ie info..." /></div>
          </div>
          
          <div style="margin-top:10px;">
             <label>ATB</label>
             <div id="atb_list_${i}"></div>
             <button class="mini primary" type="button" onclick="addATB(${i})">+ Prida≈• ATB</button>
          </div>
          
          <div class="row" style="margin-top:10px;">
            <div><label>s.c.</label><input data-k="p${i}_sc" type="text" placeholder="napr. Fraxiparine 2x" /></div>
            <div><label>i.v.</label><input data-k="p${i}_iv_med" type="text" placeholder="napr. MgSO4 2x" /></div>
          </div>
          <div class="row">
            <div><label>inf.</label><input data-k="p${i}_inf" type="text" placeholder="napr. R,O,V alebo 3x" /></div>
            <div></div>
          </div>
        </div>

        <div class="subBlock">
          <label>Kontinu√°lne teƒçie</label>
          <div id="cont_list_${i}"></div>
          <div class="inlineTools">
            <button class="mini primary" type="button" onclick="addCont(${i})">+ Prida≈• roztok</button>
            <button class="mini" type="button" onclick="clearCont(${i})">Vymaza≈•</button>
          </div>
        </div>

        <div class="subBlock">
          <label>i.v. vstupy / PK / PEG / NGS</label>
          <div class="checks">
            <label><input type="checkbox" data-k="p${i}_iv_chir_on" /> CHIR</label>
            <label><input type="checkbox" data-k="p${i}_iv_cvk_on" /> CVK</label>
            <label><input type="checkbox" data-k="p${i}_iv_hd_on" /> HD kaval</label>
            <label><input type="checkbox" data-k="p${i}_iv_hrd_on" /> Hr dr√©n</label>
            <label><input type="checkbox" data-k="p${i}_pk_on" /> PK</label>
            <label><input type="checkbox" data-k="p${i}_peg_on" /> PEG</label>
            <label><input type="checkbox" data-k="p${i}_ngs_on" /> NGS</label>
          </div>
          <div class="row" style="margin-top:10px;">
            <div id="iv_chir_box_${i}" class="hidden"><label>CHIR ‚Äì d√°tum</label><input data-k="p${i}_iv_chir_date" type="date" />
              <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_iv_chir_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_iv_chir_date','yesterday')">Vƒçera</button></div>
            </div>
            <div id="iv_cvk_box_${i}" class="hidden"><label>CVK ‚Äì d√°tum</label><input data-k="p${i}_iv_cvk_date" type="date" />
              <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_iv_cvk_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_iv_cvk_date','yesterday')">Vƒçera</button></div>
            </div>
          </div>
          <div class="row">
            <div id="iv_hd_box_${i}" class="hidden"><label>HD kaval ‚Äì d√°tum</label><input data-k="p${i}_iv_hd_date" type="date" />
               <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_iv_hd_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_iv_hd_date','yesterday')">Vƒçera</button></div>
            </div>
            <div id="iv_hrd_box_${i}" class="hidden"><label>Hr dr√©n ‚Äì d√°tum</label><input data-k="p${i}_iv_hrd_date" type="date" />
               <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_iv_hrd_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_iv_hrd_date','yesterday')">Vƒçera</button></div>
               <div style="margin-top:8px;"><label>V√Ωdaj</label><input data-k="p${i}_iv_hrd_out" type="text" placeholder="ml/hod" /></div>
            </div>
          </div>
          <div id="pk_box_${i}" class="hidden" style="margin-top:10px;"><label>PK ‚Äì d√°tum</label><input data-k="p${i}_pk_date" type="date" />
             <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_pk_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_pk_date','yesterday')">Vƒçera</button></div>
          </div>
          <div class="row" style="margin-top:10px;">
            <div id="peg_box_${i}" class="hidden"><label>PEG ‚Äì d√°tum</label><input data-k="p${i}_peg_date" type="date" />
               <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_peg_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_peg_date','yesterday')">Vƒçera</button></div></div>
            <div id="ngs_box_${i}" class="hidden"><label>NGS ‚Äì d√°tum</label><input data-k="p${i}_ngs_date" type="date" />
               <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_ngs_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_ngs_date','yesterday')">Vƒçera</button></div>
               <div style="margin-top:5px"><label>V√Ωdaj</label><input data-k="p${i}_ngs_out" type="text" placeholder="ml/hod" /></div>
            </div>
          </div>
        </div>

        <div class="subBlock">
          <div class="row">
            <div><label>MM</label><div class="checks"><label><input type="checkbox" data-k="p${i}_mm_on" /> MM</label></div><div id="mm_box_${i}" class="hidden" style="margin-top:8px;"><label>Hodnota</label><input data-k="p${i}_mm_value" type="text" /></div></div>
            <div>
              <label>KS (v√Ωber)</label>
              <select data-k="p${i}_ks_type"><option value="">Nem√°</option><option value="TKS">TKS</option><option value="DKS">DKS</option><option value="ICD">ICD</option><option value="REVEAL">REVEAL</option></select>
              <div id="ks_date_box_${i}" class="hidden" style="margin-top:8px;"><label>D√°tum zavedenia</label><input data-k="p${i}_ks_date" type="date" />
                <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_ks_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_ks_date','yesterday')">Vƒçera</button></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="subBlock">
          <label>Transport / Preklad / DH</label>
          <div class="row">
            <div>
               <label>Typ a stav</label>
               <select data-k="p${i}_transport_type">
                 <option value="">(bez z√°pisu)</option>
                 <option value="sanitka_ok">Sanitka objednan√°</option>
                 <option value="sanitka_req">Sanitku objedna≈•</option>
                 <option value="rzp_ok">RZP objednan√°</option>
                 <option value="rzp_req">RZP objedna≈•</option>
                 <option value="rlp_ok">RLP objednan√°</option>
                 <option value="rlp_req">RLP objedna≈•</option>
                 <option value="sam">Ide s√°m</option>
               </select>
            </div>
            <div><label>Kam (preklad/domov)</label><input data-k="p${i}_transport_dest" type="text" /></div>
          </div>
          <div class="row">
            <div>
               <label>Kedy (d√°tum)</label><input data-k="p${i}_transport_date" type="date" />
               <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_transport_date','tomorrow')">Zajtra</button></div>
            </div>
            <div><label>ƒåas</label><input data-k="p${i}_transport_time" type="time" /></div>
          </div>
        </div>

        <div class="subBlock">
          <label>O≈°etrovateƒæsk√° starostlivos≈•</label>
          <div class="checks">
             <label><input type="checkbox" data-k="p${i}_os_rany" /> o≈°etrovanie r√°n</label>
             <label><input type="checkbox" data-k="p${i}_os_dekub" /> dekubitov</label>
             <label><input type="checkbox" data-k="p${i}_os_poloh" /> polohovanie</label>
          </div>
          <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
             <label style="margin:0;"><input type="checkbox" data-k="p${i}_os_matrac" /> Antidekubitn√Ω matrac:</label>
             <select data-k="p${i}_os_matrac_typ" style="width:auto;"><option value="n√°≈°">n√°≈°</option><option value="pacientov">pacientov</option></select>
          </div>
        </div>

        <div class="subBlock">
          <label>Hladina lieku</label>
          <div class="row">
            <div><label>N√°zov</label><input data-k="p${i}_lvl_name" type="text" /></div>
            <div><label>D√°tum</label><input data-k="p${i}_lvl_date" type="date" /><div class="inlineTools"><button class="mini" onclick="setDate('p${i}_lvl_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_lvl_date','tomorrow')">Zajtra</button></div></div>
          </div>
          <div class="row">
            <div><label>ƒåas</label><input data-k="p${i}_lvl_time" type="time" /></div>
            <div><label>Typ</label><div class="checks"><label><input type="checkbox" data-k="p${i}_lvl_obe" /> obe</label></div></div>
          </div>
        </div>

        <div class="subBlock">
          <label>Hemokult√∫ry</label>
          <div class="row">
            <div>
              <div class="checks"><label><input type="checkbox" data-k="p${i}_hk_obe" /> obe</label></div>
              <div class="inlineTools" style="margin-top:8px;"><button class="primary mini" onclick="addHK(${i})">+ HK (poƒç√≠tadlo)</button><button class="mini" onclick="clearHK(${i})">Vymaza≈• HK</button></div>
            </div>
            <div>
              <label>D√°tum (pre pl√°n)</label><input data-k="p${i}_hk_date" type="date" />
               <div class="inlineTools"><button class="mini" onclick="setDate('p${i}_hk_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_hk_date','tomorrow')">Zajtra</button></div>
              <div style="margin-top:8px;"><label>ƒåas</label><input data-k="p${i}_hk_time" type="time" /></div>
            </div>
          </div>
          <div id="hk_list_${i}" class="hint"></div>
        </div>

        <div class="subBlock">
          <label>Krvn√© pr√≠pravky (max 4)</label>
          <div class="hint">
            <b>Zajtra:</b> Zadaj typ, d√°tum=zajtra, do "Podan√© (ks)" zadaj koƒæko PL√ÅNUJE≈† poda≈•.<br>
            <b>Dnes:</b> Zadaj typ, d√°tum=dnes, do "Podan√© (ks)" koƒæko si U≈Ω podal/a.
          </div>

          ${bloodSlotsHTML}
          
          <div class="inlineTools" style="margin-top:10px;">
            <button class="primary mini" type="button" onclick="activateNextBloodSlot(${i})">+ Prida≈• pr√≠pravok</button>
            <button class="mini danger" type="button" onclick="clearBloodAll(${i})">Vymaza≈• v≈°etko</button>
          </div>
        </div>
</div>

        <div class="subBlock">
          <label>Pl√°novan√© vy≈°etrenia</label>
          ${examBlock(i,1)}
          <details id="exam2_details_${i}" class="examDetails"><summary>Vy≈°etrenie 2 <span class="sumRight">rozbali≈•</span></summary><div style="margin-top:10px;">${examBlock(i,2, true)}</div></details>
          <details id="exam3_details_${i}" class="examDetails"><summary>Vy≈°etrenie 3 <span class="sumRight">rozbali≈•</span></summary><div style="margin-top:10px;">${examBlock(i,3, true)}</div></details>
          <div class="row" style="margin-top:10px;"><div><label>Pl√°n</label><textarea data-k="p${i}_planned"></textarea></div><div><label>Absolvovan√©</label><textarea data-k="p${i}_done"></textarea></div></div>
        </div>
        
        <div class="subBlock">
          <label>Stav pacienta</label>
          <textarea data-k="p${i}_status" placeholder="Celkov√Ω stav..."></textarea>
        </div>

        <div class="subBlock">
          <label>Ukonƒçenie</label>
          <div class="row">
            <div>
              <div class="checks"><label><input type="checkbox" data-k="p${i}_discharged" /> prepusten√Ω</label><label><input type="checkbox" data-k="p${i}_transferred" /> prelo≈æen√Ω</label></div>
              <div style="margin-top:8px;"><label>Kam</label><input data-k="p${i}_transfer_where" type="text"/></div>
            </div>
            <div class="hint">Keƒè je prepusten√Ω/prelo≈æen√Ω, klikni hore <b>Ulo≈æi≈• ako od√≠den√Ω</b>.</div>
          </div>
        </div>
      </div>
    </section>`;
  }

  function examBlock(i, n, insideDetails=false){
    const style = insideDetails ? 'style="margin-bottom:0;"' : '';
    return `
      <div class="row" ${style}>
        <div><label>N√°zov</label><input data-k="p${i}_exam${n}_text" type="text" placeholder="napr. ECHO" /></div>
        <div><label>D√°tum</label><input data-k="p${i}_exam${n}_date" type="date" /><div class="inlineTools"><button class="mini" onclick="setDate('p${i}_exam${n}_date','today')">Dnes</button><button class="mini" onclick="setDate('p${i}_exam${n}_date','tomorrow')">Zajtra</button></div></div>
      </div>
      <div class="row" style="margin-bottom:0;"><div><label>ƒåas (nepovinn√©)</label><input data-k="p${i}_exam${n}_time" type="time" /></div><div></div></div>`;
  }

  function render(){
    const root = document.getElementById("patients");
    root.innerHTML = "";
    for(let i=1;i<=5;i++){
      root.insertAdjacentHTML("beforeend", patientTemplate(i));
    }
    focusPatient(1);
  }

  // ------- State -------
  function getVal(k){
    const el = document.querySelector(`[data-k="${k}"]`);
    if(!el) return "";
    if(el.type === "checkbox") return el.checked ? "1" : "";
    return el.value ?? "";
  }
  function setVal(k, v){
    const el = document.querySelector(`[data-k="${k}"]`);
    if(!el) return;
    if(el.type === "checkbox") {
      el.checked = !!v;
      if(el.onchange) el.onchange(); 
    }
    else el.value = v ?? "";
  }
  function getState(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }
  function ensureState(){
    let st = getState();
    if(!st) st = { meta:{}, fields:{}, left:[], hk:{}, cont:{}, given:{}, atb:{} };
    if(!st.meta) st.meta = {};
    if(!st.fields) st.fields = {};
    if(!st.left) st.left = [];
    if(!st.hk) st.hk = {};
    if(!st.cont) st.cont = {};
    if(!st.given) st.given = {};
    if(!st.atb) st.atb = {};
    return st;
  }
  function save(light=false){
    const data = ensureState();
    data.meta.shiftType = document.getElementById("shiftType")?.value || "celodenna";
    data.meta.handoverDay = document.getElementById("handoverDay")?.value || todayISO();
    data.meta.nurseName = document.getElementById("nurseName")?.value || "";
    document.querySelectorAll("[data-k]").forEach(el=>{
      const k = el.getAttribute("data-k");
      if(el.type === "checkbox") data.fields[k] = el.checked ? 1 : 0;
      else data.fields[k] = el.value ?? "";
    });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    if(fileHandle && !light) scheduleSaveToDisk();
  }
  function load(){
    const st = getState();
    if(!st){
      document.getElementById("shiftType").value = "celodenna";
      document.getElementById("nurseName").value = "";
      defaultHeaderDay();
      return;
    }
    document.getElementById("shiftType").value = st.meta?.shiftType || "celodenna";
    document.getElementById("handoverDay").value = st.meta?.handoverDay || todayISO();
    document.getElementById("nurseName").value = st.meta?.nurseName || "";
    document.querySelectorAll("[data-k]").forEach(el=>{
      const k = el.getAttribute("data-k");
      if(!(k in (st.fields||{}))) return;
      if(el.type === "checkbox") el.checked = !!st.fields[k];
      else el.value = st.fields[k] ?? "";
    });
    syncAllDynamic();
    renderLeftList();
    renderHKLists();
    renderContLists();
    renderATBLists();
  }
  function resetAll(confirmAsk=true){
    if(confirmAsk && !confirm("Vymaza≈• v≈°etko?")) return;
    localStorage.removeItem(STORAGE_KEY);
    render();
    document.getElementById("shiftType").value = "celodenna";
    document.getElementById("nurseName").value = "";
    defaultHeaderDay();
    syncAllDynamic();
    save(true);
    alert("Vymazan√© ‚úÖ");
  }
  function clearPatient(i){
    if(!confirm(`Vymaza≈• Pacienta ${i}?`)) return;
    document.querySelectorAll(`#patient_${i} [data-k]`).forEach(el=>{
      if(el.type === "checkbox") {
         el.checked = false;
         if(el.onchange) el.onchange(); 
      }
      else el.value = "";
    });
    // Clear summaries too
    for(let s=1;s<=4;s++){
       const summ = document.getElementById(`blood_summary_${i}_${s}`);
       if(summ) summ.textContent = "";
    }
    const st = ensureState();
    st.hk[`p${i}`] = [];
    st.cont[`p${i}`] = [];
    st.atb[`p${i}`] = [];
    st.given[`p${i}`] = { TUEM:0, "ƒåMP":0 };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    syncAllDynamic();
    renderContLists();
    renderATBLists();
    renderHKLists();
    save();
  }
  function setDate(key, which){
    let d = todayISO();
    if(which === "yesterday") d = isoAddDays(todayISO(), -1);
    if(which === "tomorrow") d = isoAddDays(todayISO(), 1);
    setVal(key, d);
    syncAllDynamic();
    save();
  }
  function syncPatient(i){
    document.getElementById(`mm_box_${i}`)?.classList.toggle("hidden", !getVal(`p${i}_mm_on`));
    if(!getVal(`p${i}_mm_on`)) setVal(`p${i}_mm_value`, "");
    const ksType = getVal(`p${i}_ks_type`);
    const needsDateBox = (ksType === "TKS" || ksType === "DKS" || ksType === "ICD" || ksType === "REVEAL");
    document.getElementById(`ks_date_box_${i}`)?.classList.toggle("hidden", !needsDateBox);
    if(!needsDateBox) setVal(`p${i}_ks_date`, "");
    const chirOn = !!getVal(`p${i}_iv_chir_on`);
    const cvkOn = !!getVal(`p${i}_iv_cvk_on`);
    const hdOn  = !!getVal(`p${i}_iv_hd_on`);
    const hrdOn = !!getVal(`p${i}_iv_hrd_on`);
    const pkOn  = !!getVal(`p${i}_pk_on`);
    const pegOn = !!getVal(`p${i}_peg_on`);
    const ngsOn = !!getVal(`p${i}_ngs_on`);
    document.getElementById(`iv_chir_box_${i}`)?.classList.toggle("hidden", !chirOn);
    document.getElementById(`iv_cvk_box_${i}`)?.classList.toggle("hidden", !cvkOn);
    document.getElementById(`iv_hd_box_${i}`)?.classList.toggle("hidden", !hdOn);
    document.getElementById(`iv_hrd_box_${i}`)?.classList.toggle("hidden", !hrdOn);
    document.getElementById(`pk_box_${i}`)?.classList.toggle("hidden", !pkOn);
    document.getElementById(`peg_box_${i}`)?.classList.toggle("hidden", !pegOn);
    document.getElementById(`ngs_box_${i}`)?.classList.toggle("hidden", !ngsOn);
    if(!chirOn) setVal(`p${i}_iv_chir_date`, "");
    if(!cvkOn) setVal(`p${i}_iv_cvk_date`, "");
    if(!hdOn){ setVal(`p${i}_iv_hd_date`, ""); }
    if(!hrdOn){ setVal(`p${i}_iv_hrd_date`, ""); setVal(`p${i}_iv_hrd_out`, ""); }
    if(!pkOn) setVal(`p${i}_pk_date`, "");
    if(!pegOn) setVal(`p${i}_peg_date`, "");
    if(!ngsOn){ setVal(`p${i}_ngs_date`, ""); setVal(`p${i}_ngs_out`, ""); }

    // Inzulin sync
    const inzOn = !!getVal(`p${i}_inz_on`);
    document.getElementById(`inz_box_${i}`)?.classList.toggle("hidden", !inzOn);
    
    // SYNC BLOOD VISIBILITY
    syncBloodVisibility(i);
  }
  
  function syncAllDynamic(){
    for(let i=1;i<=5;i++){
      syncPatient(i);
    }
  }

  // ------- Logic -------
  function finishPatient(i){
    const moved = moveToLeftIfMarked(i, true);
    if(!moved) alert("Mus√≠te za≈°krtn√∫≈• Prepusten√Ω alebo Prelo≈æen√Ω (a ma≈• vyplnen√© meno)!");
  }
  function moveToLeftIfMarked(i, force){
    const discharged = !!getVal(`p${i}_discharged`);
    const transferred = !!getVal(`p${i}_transferred`);
    if(force && !(discharged || transferred)) return false;
    if(!force && !(discharged || transferred)) return false;
    const bed = cleanSpaces(getVal(`p${i}_bed`));
    const surname = cleanSpaces(getVal(`p${i}_surname`));
    const name = cleanSpaces(getVal(`p${i}_name`));
    if(!(bed || surname || name)) return false;
    const st = ensureState();
    st.left.unshift({
      ts: new Date().toISOString(),
      bed, surname, name,
      allergy: cleanSpaces(getVal(`p${i}_allergy`)),
      end: { discharged, transferred, where: cleanSpaces(getVal(`p${i}_transfer_where`)) }
    });
    // Clear everything, including blood hidden checkboxes
    document.querySelectorAll(`#patient_${i} [data-k]`).forEach(el=>{
      if(el.type === "checkbox") {
        el.checked = false;
        if(el.onchange) el.onchange(); 
      }
      else el.value = "";
    });
    // Clear summaries too
    for(let s=1;s<=4;s++){
       const summ = document.getElementById(`blood_summary_${i}_${s}`);
       if(summ) summ.textContent = "";
    }
    st.hk[`p${i}`] = [];
    st.cont[`p${i}`] = [];
    st.atb[`p${i}`] = [];
    st.given[`p${i}`] = { TUEM:0, "ƒåMP":0 };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    syncAllDynamic();
    renderLeftList();
    renderContLists();
    renderATBLists();
    save();
    return true;
  }
  function renderLeftList(){
    const st = ensureState();
    const root = document.getElementById("leftList");
    document.getElementById("leftCount").textContent = String((st.left||[]).length);
    if(!st.left || st.left.length === 0){ root.innerHTML = `<div class="hint">(zatiaƒæ nikto)</div>`; return; }
    root.innerHTML = st.left.slice(0,15).map((x, idx)=>{
      const fullname = cleanSpaces(`${x.surname} ${x.name}`) || "-";
      const endLines = [];
      if(x.end?.discharged) endLines.push("prepusten√Ω");
      if(x.end?.transferred) endLines.push(`prelo≈æen√Ω: ${x.end?.where || "-"}`);
      return `<div style="padding:8px; border:1px solid var(--border); border-radius:12px; margin-bottom:8px;">
          <b>${escapeHTML(x.bed || "-")}</b> ${escapeHTML(fullname)}
          <div class="hint">${escapeHTML(endLines.join(" | "))}</div>
          <button class="mini danger" style="margin-top:4px;" onclick="deleteLeft(${idx})">Zmaza≈•</button>
        </div>`;
    }).join("");
  }
  function deleteLeft(idx){
    const st = ensureState();
    st.left.splice(idx,1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderLeftList();
    save();
  }

  // --- HK / Cont / ATB ---
  function getHKKey(i){ return `p${i}`; }
  function addHK(i){
    const st = ensureState();
    const key = getHKKey(i);
    if(!st.hk[key]) st.hk[key] = [];
    st.hk[key].push({ ts: new Date().toISOString() });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderHKLists();
    save();
  }
  function clearHK(i){
    const st = ensureState();
    st.hk[getHKKey(i)] = [];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderHKLists();
    save();
  }
  function renderHKLists(){
    const st = ensureState();
    const today = todayISO();
    for(let i=1;i<=5;i++){
      const list = st.hk[getHKKey(i)] || [];
      const el = document.getElementById(`hk_list_${i}`);
      if(!el) continue;
      const todayCount = list.filter(x => x.ts.startsWith(today)).length;
      el.innerHTML = list.length ? `Dnes: ${todayCount}, Celkovo: ${list.length}` : "";
    }
  }

  function contKey(i){ return `p${i}`; }
  function addCont(i){
    const st = ensureState();
    const key = contKey(i);
    if(!st.cont[key]) st.cont[key] = [];
    st.cont[key].push({ bottle:"", volume:"", mix:"", route:"i.v", rate:"" });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderContLists();
    save(true);
  }
  function clearCont(i){
    const st = ensureState();
    st.cont[contKey(i)] = [];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderContLists();
    save();
  }
  function renderContLists(){
    const st = ensureState();
    for(let i=1;i<=5;i++){
      const root = document.getElementById(`cont_list_${i}`);
      if(!root) continue;
      const list = st.cont[contKey(i)] || [];
      if(list.length===0){ root.innerHTML = `<div class="hint">(niƒç)</div>`; continue; }
      root.innerHTML = list.map((x, idx)=>`
        <div class="row" style="margin-bottom:8px;">
          <div><label>Fƒæa≈°a</label><input type="number" value="${escapeHTML(x.bottle||"")}" oninput="setCont(${i},${idx},'bottle',this.value)" placeholder="1" /></div>
          <div><label>Objem</label><input type="number" value="${escapeHTML(x.volume||"")}" oninput="setCont(${i},${idx},'volume',this.value)" placeholder="250" /></div>
        </div>
        <div class="row" style="margin-bottom:8px;">
          <div><label>Roztok</label><input type="text" value="${escapeHTML(x.mix||"")}" oninput="setCont(${i},${idx},'mix',this.value)" placeholder="5G+NO..." /></div>
          <div><label>R√Ωchlos≈•</label><input type="text" value="${escapeHTML(x.rate||"")}" oninput="setCont(${i},${idx},'rate',this.value)" placeholder="12,4" /></div>
        </div>
        <button class="mini danger" onclick="delCont(${i},${idx})">Zmaza≈• riadok</button>
        <div style="border-top:1px dashed var(--border); margin:10px 0;"></div>
      `).join("");
    }
  }
  function setCont(i, idx, field, val){
    const st = ensureState();
    const key = contKey(i);
    if(!st.cont[key]) st.cont[key] = [];
    if(!st.cont[key][idx]) return;
    st.cont[key][idx][field] = val;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    if(fileHandle) scheduleSaveToDisk();
  }
  function delCont(i, idx){
    const st = ensureState();
    const key = contKey(i);
    st.cont[key].splice(idx,1);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderContLists();
    save();
  }
  function contPrint(i){
    const st = ensureState();
    const list = st.cont[contKey(i)] || [];
    return list.map(x=>{
      if(!(x.bottle||x.volume||x.mix||x.rate)) return "";
      return cleanSpaces(`kontinu√°lne teƒçie ${x.bottle}. fl. ${x.volume} ml ${x.mix} i.v /${x.rate} ml/h/`);
    }).filter(Boolean).join(", ");
  }
  
  // -- ATB LOGIC --
  function addATB(i){
    const st = ensureState();
    const key = `p${i}`;
    if(!st.atb[key]) st.atb[key] = [];
    st.atb[key].push({ name:"", int:"", route:"i.v." });
    localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
    renderATBLists();
    save(true);
  }
  function renderATBLists(){
    const st = ensureState();
    for(let i=1;i<=5;i++){
      const root = document.getElementById(`atb_list_${i}`);
      if(!root) continue;
      const list = st.atb[`p${i}`] || [];
      if(list.length === 0){ root.innerHTML = `<div class="hint" style="margin-bottom:6px;">(≈æiadne ATB)</div>`; continue; }
      
      root.innerHTML = list.map((x, idx)=>`
        <div style="background:var(--bg); padding:6px; border-radius:8px; border:1px solid var(--border); margin-bottom:6px;">
          <div class="row" style="margin-bottom:6px;">
             <div><input type="text" placeholder="N√°zov ATB" value="${escapeHTML(x.name||"")}" oninput="setATB(${i},${idx},'name',this.value)"></div>
             <div style="display:flex; gap:4px;">
                <input type="text" placeholder="√° x hod" value="${escapeHTML(x.int||"")}" oninput="setATB(${i},${idx},'int',this.value)">
                <select style="width:70px;" onchange="setATB(${i},${idx},'route',this.value)">
                   <option value="i.v." ${x.route==='i.v.'?'selected':''}>i.v.</option>
                   <option value="per os" ${x.route==='per os'?'selected':''}>per os</option>
                </select>
             </div>
          </div>
          <button class="mini danger" onclick="delATB(${i},${idx})">Zmaza≈• ATB</button>
        </div>
      `).join("");
    }
  }
  function setATB(i, idx, field, val){
    const st = ensureState();
    const list = st.atb[`p${i}`];
    if(list && list[idx]) {
       list[idx][field] = val;
       localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
       if(fileHandle) scheduleSaveToDisk();
    }
  }
  function delATB(i, idx){
    const st = ensureState();
    if(st.atb[`p${i}`]) {
       st.atb[`p${i}`].splice(idx,1);
       localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
       renderATBLists();
       save();
    }
  }
  function atbPrint(i){
    const st = ensureState();
    const list = st.atb[`p${i}`] || [];
    return list.map(x => {
       if(!x.name) return "";
       return cleanSpaces(`${x.name} ${x.int} ${x.route}`);
    }).filter(Boolean).join(", ");
  }

  // --- BLOOD (STATIC TOGGLE FIX) ---
  function syncBloodVisibility(i){
    // This just updates CSS based on hidden checkbox state
    for(let s=1; s<=4; s++){
      const isOn = !!getVal(`p${i}_blood${s}_on`);
      const wrap = document.getElementById(`blood_wrap_${i}_${s}`);
      
      // Update visual summary of what was given today
      const accum = parseInt(getVal(`p${i}_blood${s}_today_accumulator`)||0);
      const summEl = document.getElementById(`blood_summary_${i}_${s}`);
      if(summEl) summEl.textContent = accum > 0 ? `(Dnes u≈æ podan√©: ${accum} ks)` : "";

      if(wrap){
        if(isOn) wrap.classList.add("active");
        else wrap.classList.remove("active");
      }
    }
  }

  function activateNextBloodSlot(i){
    // Find first disabled checkbox and enable it
    for(let s=1; s<=4; s++){
      if(!getVal(`p${i}_blood${s}_on`)){
        // SAFETY: Force clear the new slot
        setVal(`p${i}_blood${s}_type`, "");
        setVal(`p${i}_blood${s}_ready`, "");
        setVal(`p${i}_blood${s}_secured`, "");
        setVal(`p${i}_blood${s}_given_count`, "");
        setVal(`p${i}_blood${s}_date`, "");
        setVal(`p${i}_blood${s}_time`, "");
        setVal(`p${i}_blood${s}_today_accumulator`, 0);
        
        // Now turn it on
        setVal(`p${i}_blood${s}_on`, 1);
        save();
        return;
      }
    }
    alert("Max 4 pr√≠pravky.");
  }

  function removeBloodSlot(i, s){
    setVal(`p${i}_blood${s}_on`, 0); // Uncheck hidden box
    // Clear values
    setVal(`p${i}_blood${s}_type`, "");
    setVal(`p${i}_blood${s}_ready`, "");
    setVal(`p${i}_blood${s}_secured`, "");
    setVal(`p${i}_blood${s}_given_count`, "");
    setVal(`p${i}_blood${s}_date`, "");
    setVal(`p${i}_blood${s}_time`, "");
    setVal(`p${i}_blood${s}_today_accumulator`, 0);
    save();
  }
  
  function clearBloodAll(i){
    for(let s=1; s<=4; s++) removeBloodSlot(i, s);
  }

  function applyBloodGiven(i, s){
    const readyKey = `p${i}_blood${s}_ready`;
    const givenKey = `p${i}_blood${s}_given_count`;
    const accumKey = `p${i}_blood${s}_today_accumulator`;

    let ready = parseInt(getVal(readyKey) || "0", 10) || 0;
    let given = parseInt(getVal(givenKey) || "0", 10) || 0;
    let currentAccum = parseInt(getVal(accumKey) || "0", 10) || 0;

    if(given <= 0) return;
    
    // Logic: subtract from ready, add to today's accumulator
    // If ready is 0, we still allow logging "given" but ready stays 0
    let newReady = Math.max(0, ready - given);
    
    setVal(readyKey, String(newReady));
    setVal(accumKey, String(currentAccum + given));
    setVal(givenKey, ""); // clear given field after applying
    save();
    syncBloodVisibility(i); // Update UI text
  }

  // --- Printing ---
  function addComma(parts, piece){ const t = cleanSpaces(piece); if(t) parts.push(t); }
  function makeDayTextFromDate(startISO){
    if(!startISO) return "";
    const start = new Date(startISO + "T00:00:00");
    if(isNaN(start.getTime())) return ""; 
    const now = new Date();
    const diff = Math.floor((new Date(now.getFullYear(),now.getMonth(),now.getDate()) - start)/(86400000));
    return (diff + 1) < 1 ? "" : `${diff + 1}. de≈à`;
  }

  function examPrintStr(label, dateISO, timeStr){
    // Returns { text: "ECHO 10:00", day: "today" | "tomorrow" | "other" }
    const lab = cleanSpaces(label);
    const d = cleanSpaces(dateISO);
    const t = formatTimeSK(timeStr);
    if(!lab) return null;
    let txt = lab;
    if(t) txt += ` ${t}`;
    
    if(d && isToday(d)) return { text: txt, day: "today" };
    if(d && isTomorrow(d)) return { text: txt, day: "tomorrow" };
    return { text: txt, day: "other" }; // Fallback
  }

  function levelPrint(name, dateISO, timeStr, obe){
    const n = cleanSpaces(name);
    if(!n) return "";
    const typ = obe ? "obe" : "rezidu√°lna";
    const d = cleanSpaces(dateISO);
    const t = formatTimeSK(timeStr);
    if(d && isToday(d)) return `dnes mal: hladina ${n} ${typ}`;
    if(d && isTomorrow(d)){
      if(t) return `zajtra ${t} hladina ${n} ${typ}`;
      return `zajtra: hladina ${n} ${typ}`;
    }
    return `hladina ${n} ${typ}`;
  }
  function labsPrint(i){
    const note = cleanSpaces(getVal(`p${i}_lab_note`));
    const d = cleanSpaces(getVal(`p${i}_lab_date`));
    const t = formatTimeSK(getVal(`p${i}_lab_time`));
    
    // Checkboxes (Done/Today)
    const sel = [];
    if(getVal(`p${i}_lab_odbery`)) sel.push("odbery");
    if(getVal(`p${i}_lab_vytery`)) sel.push("v√Ωtery");
    if(getVal(`p${i}_lab_moc`)) sel.push("moƒç K+C");
    if(getVal(`p${i}_lab_antigeny`)) sel.push("antig√©ny");
    
    let part1 = "";
    if(sel.length > 0 || note){
       let base = sel.join(", ");
       if(note) base = base ? `${base} ${note}` : note;
       
       if(d && isToday(d)) part1 = `dnes ${base}`;
       else if(d && isTomorrow(d)) part1 = `zajtra ${t} ${base}`; 
       else part1 = base; 
    }

    // Plan (Tomorrow/Other)
    const planText = cleanSpaces(getVal(`p${i}_lab_plan`));
    const planDate = cleanSpaces(getVal(`p${i}_lab_plan_date`));
    let part2 = "";
    if(planText){
      if(planDate && isTomorrow(planDate)) part2 = `zajtra ${planText}`;
      else if(planDate && isToday(planDate)) part2 = `dnes pl√°n: ${planText}`;
      else part2 = planText; 
    }

    if(part1 && part2) return `${part1}, ${part2}`;
    return part1 || part2;
  }
  
  // HK Print Logic (UPDATED)
  function hkPrint(i){
    const d = cleanSpaces(getVal(`p${i}_hk_date`));
    const t = formatTimeSK(getVal(`p${i}_hk_time`));
    const st = ensureState();
    const list = st.hk[getHKKey(i)] || [];
    
    const todayPrefix = todayISO();
    const todayCount = list.filter(x => x.ts.startsWith(todayPrefix)).length;
    const totalCount = list.length;
    
    const obe = !!getVal(`p${i}_hk_obe`) ? " obe" : "";

    // If clicked today -> show count + total (no "celkovo")
    if(todayCount > 0){
       return `dnes odobrat√° ${todayCount}x HK${obe} (${totalCount}x)`;
    }

    // Tomorrow plan
    if(d && isTomorrow(d)){
       let s = "zajtra";
       if(t) s += ` ${t}`;
       s += ` odobra≈• HK${obe}`;
       return s;
    }

    // Today but manual only (no clicks)
    if(d && isToday(d)){
       let s = "dnes";
       if(t) s += ` ${t}`;
       s += ` odobrat√° HK${obe}`;
       return s;
    }
    
    return "";
  }
  
  function bloodPrintMulti(i){
    const lines = [];
    for(let s=1;s<=4;s++){
      if(!getVal(`p${i}_blood${s}_on`)) continue;
      const type = cleanSpaces(getVal(`p${i}_blood${s}_type`));
      if(!type) continue;
      
      const ready = parseInt(getVal(`p${i}_blood${s}_ready`)||"0",10)||0;
      const secured = parseInt(getVal(`p${i}_blood${s}_secured`)||"0",10)||0;
      
      // Look at hidden accumulator for "Today Given"
      const todayGiven = parseInt(getVal(`p${i}_blood${s}_today_accumulator`)||"0",10)||0;
      
      const d = cleanSpaces(getVal(`p${i}_blood${s}_date`));
      const t = formatTimeSK(getVal(`p${i}_blood${s}_time`));

      const parts = [];

      // 1. DNES PODANA
      if(todayGiven > 0){
        parts.push(`dnes podan√° ${todayGiven} ${type}`);
      }

      // 2. PRIPRAVENE (Zostatok)
      if(ready > 0){
        if(parts.length === 0) parts.push(`pripraven√© ${ready} ${type}`);
        else parts.push(`pripraven√© ${ready}`);
      }
      
      // 3. ZAISTENE
      if(secured > 0){
         parts.push(`zaisten√© ${secured}`);
      }

      // 4. PLAN (Zajtra...)
      if(d && isTomorrow(d)){
        let p = "zajtra";
        if(t) p += ` ${t}`;
        p += " poda≈•";

        const planCount = parseInt(getVal(`p${i}_blood${s}_given_count`)||"0",10)||0;
        if(planCount > 0) p += ` ${planCount}`;

        p += ` ${type}`;
        parts.push(p);
      }

      if(parts.length > 0) lines.push(parts.join(", "));
    }
    return lines.join("; ");
  }

  function buildPrintRowsSorted(){
    const items = [];
    for(let i=1;i<=5;i++){
      const bed = cleanSpaces(getVal(`p${i}_bed`));
      if(!bed && !getVal(`p${i}_surname`)) continue;
      items.push({i, bed});
    }
    const parseBed = (s)=>{
      const m = String(s||"").match(/^\s*(\d+)\s*\/\s*(\d+)\s*$/);
      if(!m) return {room:9999, bed:9999};
      return {room: parseInt(m[1],10), bed: parseInt(m[2],10)};
    };
    items.sort((a,b)=>{
      const A = parseBed(a.bed); const B = parseBed(b.bed);
      if(A.room !== B.room) return A.room - B.room;
      return A.bed - B.bed;
    });

    return items.map(({i})=>{
      const bed = cleanSpaces(getVal(`p${i}_bed`)) || "-";
      const fullname = cleanSpaces((getVal(`p${i}_surname`) + " " + getVal(`p${i}_name`)).trim()) || "-";
      const allergy = cleanSpaces(getVal(`p${i}_allergy`));
      
      // ISOLATION
      const isoOn = !!getVal(`p${i}_iso_on`);
      const isoReason = cleanSpaces(getVal(`p${i}_iso_reason`));
      const isolationHTML = isoOn ? `<div style="color:red; font-weight:bold; font-size:11px; margin-top:2px;">IZOL√ÅCIA: ${isoReason||"√Åno"}</div>` : "";

      const parts = [];

      // 1. ZAKLAD (NP, PR, EKG, Monitor, TK)
      const admit = cleanSpaces(getVal(`p${i}_admit_date`));
      if(admit && isToday(admit)) addComma(parts, "NP");
      const pr = cleanSpaces(getVal(`p${i}_pr`));
      if(pr) addComma(parts, `"${pr}"`);
      if(getVal(`p${i}_ekg`)) addComma(parts, `EKG ${getVal(`p${i}_ekg`)}`);
      if(getVal(`p${i}_mon_check`)) addComma(parts, "monitorova≈•");
      if(getVal(`p${i}_tk`)) addComma(parts, `TK ${getVal(`p${i}_tk`)}`);

      // 2. VSTUPY (TKS, CHIR, HD, PK, **PV, MM**, NGS, Hr dren)
      const ksType = cleanSpaces(getVal(`p${i}_ks_type`));
      const ksDate = cleanSpaces(getVal(`p${i}_ks_date`));
      if(ksType){
        const day = makeDayTextFromDate(ksDate);
        addComma(parts, day ? `${ksType} ${day}` : (ksDate ? ksType : `${ksType} dlhodobo`));
      }
      if(getVal(`p${i}_iv_chir_on`)){ const d=makeDayTextFromDate(getVal(`p${i}_iv_chir_date`)); addComma(parts, d ? `CHIR ${d}`:"CHIR"); }
      if(getVal(`p${i}_iv_cvk_on`)){ const d=makeDayTextFromDate(getVal(`p${i}_iv_cvk_date`)); addComma(parts, d ? `CVK ${d}`:"CVK"); }
      if(getVal(`p${i}_iv_hd_on`)){ 
         const d=makeDayTextFromDate(getVal(`p${i}_iv_hd_date`)); 
         addComma(parts, `HD kaval ${d||""}`.trim());
      }
      if(getVal(`p${i}_pk_on`)){ const d=makeDayTextFromDate(getVal(`p${i}_pk_date`)); addComma(parts, d ? `PK ${d}`:"PK"); }
      
      // -- MOVED PV and MM HERE --
      if(getVal(`p${i}_pv_check`)) addComma(parts, "P+V");
      if(getVal(`p${i}_mm_on`)) addComma(parts, `MM: ${getVal(`p${i}_mm_value`)}`);

      if(getVal(`p${i}_peg_on`)){ const d=makeDayTextFromDate(getVal(`p${i}_peg_date`)); addComma(parts, d ? `PEG ${d}`:"PEG"); }
      if(getVal(`p${i}_ngs_on`)){ 
         const d=makeDayTextFromDate(getVal(`p${i}_ngs_date`)); 
         const out=cleanSpaces(getVal(`p${i}_ngs_out`));
         addComma(parts, `NGS ${d||""} ${out||""}`.trim());
      }
      if(getVal(`p${i}_iv_hrd_on`)){
        const d=makeDayTextFromDate(getVal(`p${i}_iv_hrd_date`));
        const out=cleanSpaces(getVal(`p${i}_iv_hrd_out`));
        addComma(parts, `Hr dr√©n ${d||""} ${out||""}`.trim());
      }

      // 3. LIEƒåBA (s.c., i.v., inf., ATB, Kontinu√°lky)
      if(getVal(`p${i}_sc`)) addComma(parts, `s.c. ${getVal(`p${i}_sc`)}`);
      if(getVal(`p${i}_iv_med`)) addComma(parts, `i.v. ${getVal(`p${i}_iv_med`)}`);
      if(getVal(`p${i}_inf`)) addComma(parts, `inf. ${getVal(`p${i}_inf`)}`);
      // ATB LIST
      addComma(parts, atbPrint(i));
      // Kontinu√°lky
      addComma(parts, contPrint(i));

      // 4. HLADINY
      addComma(parts, levelPrint(getVal(`p${i}_lvl_name`), getVal(`p${i}_lvl_date`), getVal(`p${i}_lvl_time`), !!getVal(`p${i}_lvl_obe`)));

      // 5. DIETA / METABOLIZMUS
      const gp = cleanSpaces(getVal(`p${i}_gp_type`));
      if(gp) addComma(parts, gp);
      if(getVal(`p${i}_inz_on`)){
        const loc = getVal(`p${i}_inz_loc`);
        addComma(parts, `Inz. dƒæa glyk√©mie - per√° ${loc}`);
      }

      // 6. KRVNE PRIPRAVKY
      addComma(parts, bloodPrintMulti(i));

      // 7. O≈†ETROVATEƒΩSTVO
      const nur = [];
      if(getVal(`p${i}_os_rany`)) nur.push("o≈°etrovanie r√°n");
      if(getVal(`p${i}_os_dekub`)) nur.push("o≈°etrovanie dekubitov");
      if(getVal(`p${i}_os_poloh`)) nur.push("polohovanie");
      if(getVal(`p${i}_os_matrac`)){
         const typ = getVal(`p${i}_os_matrac_typ`);
         nur.push(`antidekubitn√Ω matrac (${typ})`);
      }
      if(nur.length) addComma(parts, nur.join(", "));
      
      // 8. SLEDOVA≈§
      if(getVal(`p${i}_watch`)) addComma(parts, `sledova≈• ${getVal(`p${i}_watch`)}`);

      // 9. VY≈†ETRENIA (LABAKY + HK + EXAMS)
      addComma(parts, labsPrint(i));
      addComma(parts, hkPrint(i));

      let todayExams = [];
      let tomExams = [];
      for(let n=1;n<=3;n++){
        const ex = examPrintStr(getVal(`p${i}_exam${n}_text`), getVal(`p${i}_exam${n}_date`), getVal(`p${i}_exam${n}_time`));
        if(ex){
           if(ex.day === "today") todayExams.push(ex.text);
           else if(ex.day === "tomorrow") tomExams.push(ex.text);
           else addComma(parts, ex.text); 
        }
      }
      if(todayExams.length > 0) addComma(parts, "dnes mal " + todayExams.join(", "));
      if(tomExams.length > 0) addComma(parts, "zajtra " + tomExams.join(", "));

      // 10. TRANSPORT / PREKLAD (REVISED LOGIC 1.28)
      const transType = cleanSpaces(getVal(`p${i}_transport_type`));
      const transDest = cleanSpaces(getVal(`p${i}_transport_dest`));
      const transDate = cleanSpaces(getVal(`p${i}_transport_date`));
      const transTime = formatTimeSK(getVal(`p${i}_transport_time`));

      if(transType && transType !== "(bez z√°pisu)"){
         const map = {
            "sanitka_ok": { who: "sanitka", action: "je objednan√°" },
            "sanitka_req": { who: "sanitku", action: "objedna≈•" }, 
            "rzp_ok": { who: "RZP", action: "je objednan√°" },
            "rzp_req": { who: "RZP", action: "objedna≈•" },
            "rlp_ok": { who: "RLP", action: "je objednan√°" },
            "rlp_req": { who: "RLP", action: "objedna≈•" },
            "sam": { who: "ide s√°m", action: "" }
         };

         let info = map[transType];
         if(!info) info = { who: transType, action:"" }; 

         let phrase = "";
         
         // 1. Date
         if(transDate){
            if(isTomorrow(transDate)) phrase += "zajtra";
            else if(isToday(transDate)) phrase += "dnes";
            else phrase += formatDateSK(transDate);
         }
         
         // 2. Dest
         if(transDest) phrase += " " + transDest;
         
         // 3. Who
         if(info.who) phrase += " " + info.who;

         // 4. Action + Time
         if(info.action){
            phrase += " " + info.action;
            if(transTime) phrase += " na " + transTime;
         } else {
             if(transTime) phrase += " " + transTime;
         }

         addComma(parts, phrase.trim());
      }

      // 11. STAV PACIENTA + OSTATN√â
      if(getVal(`p${i}_status`)) addComma(parts, getVal(`p${i}_status`));
      if(getVal(`p${i}_drugs`)) addComma(parts, getVal(`p${i}_drugs`));
      if(getVal(`p${i}_planned`)) addComma(parts, getVal(`p${i}_planned`));
      if(getVal(`p${i}_done`)) addComma(parts, getVal(`p${i}_done`));
      if(getVal(`p${i}_note`)) addComma(parts, getVal(`p${i}_note`));

      return { bed, fullname, allergy, isolationHTML, third: parts.join(", ") };
    });
  }

  function buildLeftRowsForPrint(){
    const st = ensureState();
    const sorted = (st.left||[]).filter(x=>x.end?.discharged || x.end?.transferred);
    return sorted.map(x=>{
      const bed = x.bed || "-";
      const fullname = cleanSpaces(`${x.surname||""} ${x.name||""}`) || "-";
      const allergy = x.allergy || "";
      const endLines = [];
      if(x.end?.discharged) endLines.push("prepusten√Ω");
      if(x.end?.transferred) endLines.push(`prelo≈æen√Ω: ${x.end?.where || "-"}`);
      return { bed, fullname, allergy, third: endLines.join("\n") };
    });
  }

  function printFilledIOS(){
    save(true);
    const activeRows = buildPrintRowsSorted();
    const leftRows = buildLeftRowsForPrint();
    const shift = (document.getElementById("shiftType").value === "nocna") ? "Noƒçn√© hl√°senie" : "Celodenn√© hl√°senie";
    const day = formatDateSK(document.getElementById("handoverDay").value);
    const nurse = document.getElementById("nurseName").value;

    let rowsHTML = activeRows.map(r=>`
      <div class="r">
        <div class="c1">${escapeHTML(r.bed)}</div>
        <div class="c2">
           <div class="nm">${escapeHTML(r.fullname)}</div>
           ${r.allergy ? `<div class="aa">AA: ${escapeHTML(r.allergy)}</div>` : ``}
           ${r.isolationHTML}
        </div>
        <div class="c3">${escapeHTML(r.third)}</div>
      </div>`).join("");

    if(leftRows.length){
      rowsHTML += `<div style="margin:10px 0; border-top:2px solid #999;"></div><div style="font-size:12px; margin-bottom:6px;"><b>Od√≠den√≠</b></div>` +
      leftRows.map(r=>`
        <div class="r">
          <div class="c1">${escapeHTML(r.bed)}</div>
          <div class="c2"><div class="nm">${escapeHTML(r.fullname)}</div>${r.allergy ? `<div class="aa">AA: ${escapeHTML(r.allergy)}</div>` : ``}</div>
          <div class="c3">${escapeHTML(r.third).replace(/\n/g,"<br>")}</div>
        </div>`).join("");
    }
    if(!rowsHTML) rowsHTML = `<div>(Pr√°zdne)</div>`;

    const html = `<!doctype html><html><head><meta charset="utf-8"/><title>Tlaƒç</title>
      <style>
        body{font-family:sans-serif; margin:0; padding:0; font-size:13px; line-height:1.35; color:#111;}
        * { font-family: sans-serif !important; }
        @page { margin: 8mm; }
        .head{ font-size:14px; margin-bottom:10px; font-weight:700; }
        .r{display:grid; grid-template-columns: 62px 200px 1fr; gap:10px; padding:6px 0; border-bottom:1px solid #ddd; align-items:start;}
        .c1,.nm{font-weight:700; white-space:nowrap;}
        .aa{font-size:12px;}
        .c3{white-space:normal; word-break:break-word;}
      </style></head><body>
      <div class="head">${escapeHTML(shift)} ‚Äì ${escapeHTML(day)}, sestra: ${escapeHTML(nurse)}</div>
      ${rowsHTML}
      <script>window.onload=()=>window.print();<\/script></body></html>`;

    const w = window.open("", "_blank");
    if(!w){ alert("Povoƒæ pop-ups!"); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }
  function exportJSON(){
    save(true);
    const blob = new Blob([localStorage.getItem(STORAGE_KEY)||"{}"], {type:"application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "Hlasenie_v132_HK_Fonts.json";
    document.body.appendChild(a); a.click(); a.remove();
  }

  let debounceTimer;
  document.addEventListener("input", (e)=>{
    if(e.target && e.target.matches("[data-k], #handoverDay, #nurseName")){
      clearTimeout(debounceTimer); debounceTimer = setTimeout(()=>save(true), 800);
    }
  });
  document.addEventListener("change", (e)=>{
    if(e.target && e.target.matches("[data-k], #handoverDay, #nurseName, #shiftType")){ syncAllDynamic(); save(); }
  });
  document.addEventListener("DOMContentLoaded", ()=>{ render(); defaultHeaderDay(); load(); save(true); });
</script>
</body>
</html>
